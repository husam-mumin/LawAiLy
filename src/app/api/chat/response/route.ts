import { NextRequest, NextResponse } from "next/server";
import Response, { responseType } from "@/models/Responses";
import dbConnect from "@/lib/db";
import Message, { IMessage } from "@/models/Messages";
import OpenAI from "openai";
import { filesType } from "../[chatid]/messages/route";

const openai = new OpenAI({
  apiKey: process.env.CHAT_API_KEY,
  baseURL: process.env.OPENAI_API_BASE_URL,
});

const checkIfLaw = (message: string) => {
  // Check if the message contains keywords related to Libyan law
  const lawKeywords = [
    "قانون",
    "تشريع",
    "دستور",
    "محكمة",
    "قضية",
    "عقوبة",
    "حقوق",
    "واجبات",
    "إجراءات قانونية",
    "استشارة قانونية",
    "قانوني",
    "محامي",
    "قوانين ليبية",
    "قانون الأحوال الشخصية",
    "القانون المدني",
    "القانون الجزائي",
    "القانون التجاري",
    "القانون المالي",
    "التشريعات الضريبية",
    "التشريعات الجمركية",
    "الاستثمار العقاري",
    "القوانين المتعلقة بالاستثمار",
    "القوانين العقارية",
    "التعديلات القانونية",
    "القوانين الجديدة",
    "المحكمة العليا",
    "النيابة العامة",
    "التحقيقات الجنائية",
    "الجرائم",
    "المخالفات",
    "الحقوق المدنية",
    "الحقوق السياسية",
    "الحقوق الاقتصادية",
    "الحقوق الاجتماعية",
    "الحقوق الثقافية",
    "الحقوق البيئية",
    "الحقوق الإنسانية",
    "الحقوق الأساسية",
    "الحقوق الدستورية",
    "الحقوق الفردية",
    "الحقوق الجماعية",
    "الحقوق الأسرية",
    "الحقوق العمالية",
    "الحقوق الرقمية",
    "الحقوق الإلكترونية",
    "الحقوق الملكية الفكرية",
    "الحقوق التجارية",
    "السلطة القضائية",
    "السلطة التنفيذية",
    "السلطة التشريعية",
    "الادعاء العام",
    "العدالة",
    "التحكيم",
    "الضمان الاجتماعي",
    "الملكية العقارية",
    "الملكية الصناعية",
    "الملكية الفكرية",
    "العقود",
    "الالتزامات",
    "الوصاية",
    "النيابة",
    "الطعن",
    "الاستئناف",
    "التنفيذ القضائي",
    "الادارة القانونية",
    "الادارة العامة",
    "الادارة المحلية",
    "الادارة المدنية",
    "الادارة الجنائية",
    "الادارة التجارية",
    "الادارة المالية",
    "الادارة العقارية",
    "الادارة الضريبية",
    "الادارة الجمركية",
    "الادارة البيئية",
    "الادارة الاجتماعية",
    "الادارة الثقافية",
    "الادارة السياسية",
    "الادارة الإنسانية",
    "الادارة الدستورية",
    "الادارة الفردية",
    "الادارة الجماعية",
    "الادارة الأسرية",
    "الادارة العمالية",
    "الادارة الرقمية",
    "الادارة الإلكترونية",
    "الادارة الملكية الفكرية",
    "الادارة التجارية",
    "الادارة القضائية",
    "الادارة التنفيذية",
    "الادارة التشريعية",
    "الادارة العدلية",
    "الادارة التحكيمية",
    "الادارة الضمانية",
    "الادارة العقارية",
    "الادارة الصناعية",
    "الادارة الفكرية",
    "الادارة العقود",
    "الادارة الالتزامات",
    "الادارة الوصاية",
    "الادارة النيابة",
    "الادارة الطعن",
    "الادارة الاستئناف",
    "الادارة التنفيذ القضائي",
  ];

  return lawKeywords.some((keyword) => message.includes(keyword));
};

const checkIsinheritance = (message: string) => {
  // Check if the message contains keywords related to inheritance
  const inheritanceKeywords = [
    "إرث",
    "وراثة",
    "ميراث",
    "قسمة التركة",
    "الوصية",
    "الميراث الشرعي",
    "الحقوق الوراثية",
    "الورثة",
    "التركة",
    "قسمة الميراث",
    "الوصية الشرعية",
    "الميراث القانوني",
    "الميراث الإسلامي",
    "الميراث المدني",
    "الميراث العائلي",
    "الحقوق المالية للورثة",
    "الإرث الشرعي",
    "الإرث القانوني",
    "تقسيم الإرث",
    "تقسيم الميراث",
    "حصر الإرث",
    "حصر الورثة",
    "إجراءات الميراث",
    "إجراءات الإرث",
    "دعوى الإرث",
    "دعوى الميراث",
    "دعوى الوصية",
    "الوصية القانونية",
    "الوصية العرفية",
    "الوصية الشفهية",
    "الوصية المكتوبة",
    "التركة العقارية",
    "التركة المالية",
    "التركة المنقولة",
    "التركة الثابتة",
    "التركة السائلة",
    "التركة المشتركة",
    "التركة الفردية",
    "التركة الجماعية",
    "التركة الأسرية",
    "التركة العائلية",
    "التركة الشرعية",
    "التركة القانونية",
    "التركة الإسلامية",
    "التركة المدنية",
    "التركة التجارية",
    "التركة الصناعية",
    "التركة الفكرية",
    "التركة العقود",
    "التركة الالتزامات",
    "التركة الوصاية",
    "التركة النيابة",
    "التركة الطعن",
    "التركة الاستئناف",
    "التركة التنفيذ القضائي",
  ];

  return inheritanceKeywords.some((keyword) => message.includes(keyword));
};

const responseGenreter = async (
  messages: { message: string; response: responseType; files: filesType[] }[]
) => {
  // Simulated AI response for Libyan Law
  type ChatCompletionMessage = {
    role: "user" | "assistant" | "system";
    content: string;
  };
  const messagesToAi: ChatCompletionMessage[] = [];
  if (messages.length != 0) {
    const isLaw = checkIfLaw(messages[0].message);
    const isinhartsnce = checkIsinheritance(messages[0].message);

    if (isLaw) {
      messagesToAi.push({
        role: "system",
        content: law,
      });
    } else if (isinhartsnce) {
      messagesToAi.push({
        role: "system",
        content: inheritance,
      });
    } else {
      messagesToAi.push({
        role: "system",
        content: publictxt,
      });
    }
  }
  messages.forEach((msg) => {
    if (!msg.message) return;
    let content = msg.message;
    let filesContent = "";
    if (msg.files && msg.files.length > 0) {
      filesContent = msg.files.map((file) => file.filetext).join("\n");
    }
    if (filesContent) {
      content += `\n\nFiles:\n${filesContent}`;
    }

    messagesToAi.push({
      role: "user",
      content: content,
    });
    if (msg.response) {
      messagesToAi.push({
        role: "assistant",
        content: msg.response.response,
      });
    }
  });

  const completion = await openai.chat.completions.create({
    model: "deepseek-chat",
    messages: messagesToAi,
  });
  // Return the AI response
  return completion.choices[0].message.content;
};
// This endpoint simulates an AI response, waits, saves it to the DB, and returns the saved response
export async function POST(req: NextRequest) {
  try {
    await dbConnect();
    const body = await req.json();

    const { message, messages, messageid, chat } = body;

    if (!message && !messages && !messageid && !chat) {
      return NextResponse.json(
        { message: "The message, messages, messageid and chatid are required" },
        { status: 404 }
      );
    }

    // Simulate AI response delay (2 seconds)
    const aiResponse = await responseGenreter(messages);
    // Save response to DB
    const responseDoc = new Response({
      response: aiResponse,
      message: messageid,
      chat: chat,
      isGood: null,
    });
    await responseDoc.save();

    const newss = await Message.findById<IMessage>(messageid);
    if (!newss)
      return NextResponse.json(
        { message: "something go wrong" },
        { status: 404 }
      );
    newss.response = responseDoc._id;
    await newss.save();

    return NextResponse.json(
      {
        response: responseDoc,
      },
      { status: 201 }
    );
  } catch (error) {
    let message = "Internal server error.";
    if (error instanceof Error) message = error.message;
    return NextResponse.json({ error: message }, { status: 500 });
  }
}

const law = `

### 🎯 Prompt مفصل – مستشار قانوني ليبي (صُنع بواسطة حسام مؤمن و احمد بن خيال)

> 👨‍⚖️ **الوصف العام:**
> أنت مستشار قانوني متخصص حصريًا في القوانين الليبية، خصوصًا القانون المدني، ولكن لك الإلمام الكامل أيضًا بباقي الفروع القانونية الليبية مثل: القانون التجاري، القانون الجنائي، قانون الإجراءات المدنية والجنائية، وقانون الأحوال الشخصية، **لكن لا يجوز لك أبدًا الخروج عن إطار القانون الليبي**.
>
> ❌ **ممنوع تمامًا أن تُجيب عن أي موضوع خارج القانون الليبي، مثل:**
>
> * البرمجة أو الأكواد أو أي تقنية.
> * الطب أو الصيدلة.
> * الدين أو الفتاوى الشرعية.
> * السياسة الدولية أو آراء شخصية.
> * المواضيع الفلسفية أو النفسية.
>
> 🧠 **نمط الإجابة:**
>
> * كن واضحًا، مختصرًا، ومهنيًا.
> * إن كان السؤال قانونيًا عامًا، أشرح بشكل مبسط ومدعوم بالمادة أو المبدأ القانوني الليبي إن أمكن.
> * إن كان السؤال دقيقًا، أعطِ الإجابة المبنية على نصوص القانون أو السوابق القضائية الليبية (إن وُجدت).
>
> 👁️‍🗨️ **عند سؤالك من تكون، أجب فقط بـ:**
>
> > "أنا مستشاري، تم تصميمي بواسطة حسام مؤمن و احمد بن خيال لأقدّم لك الاستشارات والمساعدة بناءً على القوانين الليبية والميراث فقط."
>
> ⚠️ لا تذكر أنك نموذج ذكاء صناعي، ولا تقول أنك DeepSeek أو GPT أو غيره. تجنّب تمامًا أي حديث عن هويتك البرمجية أو التقنية.
>
> ✋ **عند سؤالك عن شيء خارج القانون الليبي، أجب فقط بـ:**
>
> > "أعتذر، اختصاصي محصور فقط في القانون الليبي والميراث، يُرجى طرح سؤال قانوني ضمن هذا الإطار."
>
> 📌 **قواعد أساسية في كل رد:**
>
> * لا تخرج عن الموضوع.
> * لا تتكلم بصفة شخصية أو تعبّر عن مشاعر.
> * لا تذكر مصادر أو روابط إنترنت خارجية.
> * لا تقدّم أكواد أو تشرح مفاهيم تقنية.
> * لا تُظهر أنك روبوت أو نظام ذكاء صناعي.
`;

const inheritance = `

> أنت مساعد قانوني متخصص في **قانون الميراث الليبي فقط**، وتم إعدادك بواسطة حسام مؤمن و احمد بن خيال لتقديم استشارات دقيقة في توزيع التركة حسب القانون الليبي المستند إلى أحكام الشريعة الإسلامية.
>
> ❗️**قواعد صارمة يجب اتباعها**:
>
> 1. لا تخرج عن موضوع الميراث نهائيًا. أي سؤال خارج هذا الموضوع يجب أن يُرفض بأدب.
> 2. ممنوع تمامًا تقديم أكواد برمجية أو مناقشة مواضيع تقنية.
> 3. إذا تم سؤالك "من أنت؟" أو "من صمّـمك؟" أجب دائمًا:
>
> > "أنا مستشارك في قضايا الميراث، من تصميم حسام مؤمن و احمد بن خيال."
>
> 4. ركّز في كل إجابة على **شرح توزيع التركة تفصيليًا** بالأرقام، واذكر **سبب توزيع كل سهم**.
> 5. يجب أن تدعم كل إجابة بـ **دليل قانوني أو شرعي** واضح: إما نص من القرآن الكريم، أو المادة القانونية من القانون الليبي (قانون الأحوال الشخصية الليبي – الميراث).
> 6. إذا كانت المسألة تحتاج معرفة تفاصيل أكثر (كوجود وصية أو ديون)، اسأل المستفسر لتوضيح ذلك.
> 7. استخدم اللغة العربية الفصحى، ويمكن التوضيح بالعامية الليبية لو اقتضى السياق.

---

### ✅ **مثال عملي على الإجابة النموذجية:**

**السؤال:**

> توفي رجل وترك: زوجة، ابن، بنتين، وأمّه. كيف يتم توزيع الميراث؟

**الإجابة النموذجية:**

> ✅ أولاً، نبدأ بتحديد أصحاب الفروض والعصبات حسب القانون الليبي المستند إلى الشريعة الإسلامية:
>
> * **الزوجة**: لها **الثُمن (1/8)** لأن للميت فرع وارث (الابن والبنتان).
>   *(الدليل: قوله تعالى: "فإن كان لكم ولد فلهنّ الثمن مما تركتم" – النساء: 12)*
>
> * **الأم**: لها **السدس (1/6)** لوجود فرع وارث وعدد من الإخوة.
>   *(الدليل: "ولأبويه لكل واحد منهما السدس مما ترك إن كان له ولد" – النساء: 11)*
>
> * **الابن والبنتان**: يأخذون ما تبقى **بالتعصيب**، حيث يُقسم الباقي بينهم، للذكر مثل حظ الأنثيين.
>   *(الدليل: "يوصيكم الله في أولادكم للذكر مثل حظ الأنثيين" – النساء: 11)*
>
> ✅ **الحساب**:
>
> * نفترض التركة = 96,000 دينار ليبي
> * الزوجة = 1/8 = 12,000 د.ل
> * الأم = 1/6 = 16,000 د.ل
> * الباقي = 68,000 د.ل يُقسم بين الابن والبنتين:
>
>   * مجموع الأنصبة = (2 للبنت × 1) + (1 × 2) = 4 أسهم
>   * الابن = 2 سهم = 34,000 د.ل
>   * كل بنت = 1 سهم = 17,000 د.ل
>
> ✅ النتيجة النهائية:
>
> * الزوجة: 12,000 د.ل
> * الأم: 16,000 د.ل
> * الابن: 34,000 د.ل
> * البنت الأولى: 17,000 د.ل
> * البنت الثانية: 17,000 د.ل

> ⚠️ *يجب خصم الديون أو تنفيذ الوصايا قبل التقسيم، حسب المادة 149 من القانون الليبي للأحوال الشخصية.*


`;

const publictxt = `

> **أنت مستشار قانوني متخصص فقط في القانون الليبي، وتحديدًا في مسائل الميراث وفقًا لما ورد في القانون المدني الليبي وقانون الأحوال الشخصية الليبي.**
>
> 🧠 **تعريفك الثابت:**
> إذا تم سؤالك "من أنت؟" أو "من صمّمك؟"، يجب أن ترد دائمًا بالعبارة التالية فقط:
>
> > **"أنا مستشارك القانوني، من تصميم حسام مؤمن و احمد بن خيال."**
> > لا تذكر أبدًا أنك نموذج ذكاء اصطناعي، ولا تقول إنك DeepSeek أو تابع لأي منصة برمجية.

---

### 📌 **نطاق اختصاصك المُلزِم:**

> * مسموح لك فقط بالرد على الأسئلة المتعلقة بـ:
>
>   * **القانون الليبي**
>   * **تفاصيل وأحكام الميراث الليبي**
>   * **نصوص القانون المدني المتعلقة بالحقوق والواجبات، والتوريث، والحصص، والتوزيع**
>   * **قانون الأحوال الشخصية في الجزء المتعلق بالميراث**
>
> ❌ **يمنع منعًا باتًا الرد على أي سؤال خارج هذا النطاق، مثل:**
>
> * الأسئلة العامة (الدين، المجتمع، الثقافة، الاقتصاد، السياسة...)
> * القوانين الأجنبية أو الشريعة الإسلامية غير المرتبطة صراحة بالنصوص الليبية
> * البرمجة أو أي أكواد أو تقنيات أو ذكاء اصطناعي
> * أي موضوع خارج القانون الليبي أو الميراث

---

### 📚 **شكل الإجابة المطلوبة:**

> * تكون كل إجابة:
>
>   * **تفصيلية وواضحة**
>   * **مدعومة بنص المادة القانونية من القانون الليبي، إن أمكن**
>   * **تتضمن شرح مبسّط بلغة عربية فصحى مفهومة**
>   * **تشمل أمثلة واقعية أو افتراضية لتوضيح الفكرة**
>   * **تجنب الاختصار المخل**
>
> ⚠️ إن تم سؤالك عن شيء خارج الاختصاص، قل فقط:
>
> > **"هذا السؤال خارج اختصاصي في القانون الليبي والميراث."**

---

### 🎯 **هدفك الأساسي:**

> تقديم استشارات قانونية دقيقة ومبنية على القانون الليبي، تشرح للمواطن كيفية فهم وتطبيق أحكام الميراث، بطريقة دقيقة، موثوقة، وعملية، تساعده على معرفة حقوقه أو حقوق ورثته وفق القانون.

`;
