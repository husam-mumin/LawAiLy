import { NextRequest, NextResponse } from "next/server";
import Response, { responseType } from "@/models/Responses";
import dbConnect from "@/lib/db";
import Message, { IMessage } from "@/models/Messages";
import OpenAI from "openai";
import { filesType } from "../[chatid]/messages/route";

const openai = new OpenAI({
  apiKey: process.env.CHAT_API_KEY,
  baseURL: process.env.OPENAI_API_BASE_URL,
});

const checkIfLaw = (message: string) => {
  // Check if the message contains keywords related to Libyan law
  const lawKeywords = [
    "قانون",
    "تشريع",
    "دستور",
    "محكمة",
    "قضية",
    "عقوبة",
    "حقوق",
    "واجبات",
    "إجراءات قانونية",
    "استشارة قانونية",
    "قانوني",
    "محامي",
    "قوانين ليبية",
    "قانون الأحوال الشخصية",
    "القانون المدني",
    "القانون الجزائي",
    "القانون التجاري",
    "القانون المالي",
    "التشريعات الضريبية",
    "التشريعات الجمركية",
    "الاستثمار العقاري",
    "القوانين المتعلقة بالاستثمار",
    "القوانين العقارية",
    "التعديلات القانونية",
    "القوانين الجديدة",
    "المحكمة العليا",
    "النيابة العامة",
    "التحقيقات الجنائية",
    "الجرائم",
    "المخالفات",
    "الحقوق المدنية",
    "الحقوق السياسية",
    "الحقوق الاقتصادية",
    "الحقوق الاجتماعية",
    "الحقوق الثقافية",
    "الحقوق البيئية",
    "الحقوق الإنسانية",
    "الحقوق الأساسية",
    "الحقوق الدستورية",
    "الحقوق الفردية",
  ];

  return lawKeywords.some((keyword) => message.includes(keyword));
};

const checkIsinheritance = (message: string) => {
  // Check if the message contains keywords related to inheritance
  const inheritanceKeywords = [
    "إرث",
    "وراثة",
    "ميراث",
    "قسمة التركة",
    "الوصية",
    "الميراث الشرعي",
    "الحقوق الوراثية",
    "الورثة",
    "التركة",
    "قسمة الميراث",
    "الوصية الشرعية",
    "الميراث القانوني",
    "الميراث الإسلامي",
    "الميراث المدني",
    "الميراث العائلي",
    "الحقوق المالية للورثة",
    "الإرث الشرعي",
    "الإرث القانوني",
  ];

  return inheritanceKeywords.some((keyword) => message.includes(keyword));
};

const responseGenreter = async (
  messages: { message: string; response: responseType; files: filesType[] }[]
) => {
  // Simulated AI response for Libyan Law
  type ChatCompletionMessage = {
    role: "user" | "assistant" | "system";
    content: string;
  };
  const messagesToAi: ChatCompletionMessage[] = [];
  if (messages.length === 1) {
    const isLaw = checkIfLaw(messages[0].message);
    const isinhartsnce = checkIsinheritance(messages[0].message);

    if (isLaw) {
      messagesToAi.push({
        role: "system",
        content: law,
      });
    } else if (isinhartsnce) {
      messagesToAi.push({
        role: "system",
        content: inheritance,
      });
    } else {
      messagesToAi.push({
        role: "system",
        content: publictxt,
      });
    }
  }
  messages.forEach((msg) => {
    if (!msg.message) return;
    let content = msg.message;
    let filesContent = "";
    if (msg.files && msg.files.length > 0) {
      filesContent = msg.files.map((file) => file.filetext).join("\n");
    }
    if (filesContent) {
      content += `\n\nFiles:\n${filesContent}`;
    }

    messagesToAi.push({
      role: "user",
      content: content,
    });
    if (msg.response) {
      messagesToAi.push({
        role: "assistant",
        content: msg.response.response,
      });
    }
  });

  const completion = await openai.chat.completions.create({
    model: "deepseek-chat",
    messages: messagesToAi,
  });
  // Return the AI response
  return completion.choices[0].message.content;
};
// This endpoint simulates an AI response, waits, saves it to the DB, and returns the saved response
export async function POST(req: NextRequest) {
  try {
    await dbConnect();
    const body = await req.json();

    const { message, messages, messageid, chat } = body;

    if (!message && !messages && !messageid && !chat) {
      return NextResponse.json(
        { message: "The message, messages, messageid and chatid are required" },
        { status: 404 }
      );
    }

    // Simulate AI response delay (2 seconds)
    const aiResponse = await responseGenreter(messages);
    // Save response to DB
    const responseDoc = new Response({
      response: aiResponse,
      message: messageid,
      chat: chat,
      isGood: null,
    });
    await responseDoc.save();

    const newss = await Message.findById<IMessage>(messageid);
    if (!newss)
      return NextResponse.json(
        { message: "something go wrong" },
        { status: 404 }
      );
    newss.response = responseDoc._id;
    await newss.save();

    return NextResponse.json(
      {
        response: responseDoc,
      },
      { status: 201 }
    );
  } catch (error) {
    let message = "Internal server error.";
    if (error instanceof Error) message = error.message;
    return NextResponse.json({ error: message }, { status: 500 });
  }
}

const law = `
أنت نموذج ذكاء اصطناعي يُدعى "مستشاري"، صُممت كجزء من مشروع تخرج الطالب حسام فرج مؤمن. مهمتك هي تقديم إجابات نصية فقط في القانون الليبي، مع التركيز على قوانين الميراث، مع الالتزام بالقواعد التالية بدقة:

الاختصاص الحصري:

لا تتعامل إلا مع الأسئلة المتعلقة بـ القانون الليبي، خاصة قانون الميراث.

إذا كان السؤال خارج هذا النطاق، قل: "عذرًا، أنا متخصص فقط في القانون الليبي وقضايا الميراث."

المصادر والموثوقية:

استند دائمًا إلى القوانين الليبية المعتمدة (مثل قانون الأحوال الشخصية، الجريدة الرسمية).

إذا كانت المعلومة غير مؤكدة، قل: "هذه المعلومة تحتاج مراجعة محامٍ متخصص في القانون الليبي."

الوظائف الرئيسية:

تفسير مواد الميراث (مثل الأنصبة الشرعية، الوصية الواجبة).

الإجابة على استفسارات الميراث (مثل حق الزوجة، توزيع التركة بين الذكور والإناث).

توضيح شروط استحقاق الورثة وفق القانون الليبي.

الامتثال الأخلاقي:

لا تقدم نصائح تخالف الشريعة الإسلامية أو النظام العام في ليبيا.

ذكِّر المستخدم بأن الإجابات ليست ملزمة قانونًا، ويجب استشارة محكمة أو محامٍ لقضايا الميراث المعقدة.

نمط التفاعل:

كن واضحًا ومختصرًا، مع استخدام لغة بسيطة.

ركز على النصوص القانونية دون حشو أو آراء شخصية.

مثال على التفاعل:

المستخدم: "كيف يُوزع الميراث بين البنت والأخ في القانون الليبي؟"

أنت: "وفقًا للمادة (X) من قانون الأحوال الشخصية الليبي، للبنت النصف فرضًا إذا لم يكن لها إخوة ذكور، وللأخ الباقي تعصيبًا. يُنصح مراجعة محكمة الأحوال الشخصية لتطبيق ذلك على حالتك."

يرجى الالتزام بهذه التعليمات بدقة.
`;

const inheritance = `
الهدف:
إنشاء نموذج ذكاء صناعي (AI) يعمل كمستشار قانوني افتراضي متخصص في قضايا الميراث وفق القانون الليبي، قادر على تقديم إجابات دقيقة، وحساب الأنصبة، وتقديم استشارات قانونية بناءً على التشريعات الليبية.

1. المهام الرئيسية للنموذج:
حساب الأنصبة القانونية بدقة بناءً على نظام الميراث في القانون الليبي.

تحليل الوضع القانوني للورثة (مثل استبعاد غير المستحقين وفقاً للقانون).

شرح الأحكام القانونية مع الاستناد إلى النصوص التشريعية الليبية (مثل قانون الأسرة الليبي، القوانين ذات الصلة).

حل المشكلات المعقدة مثل الوصايا، الديون، والإجراءات القضائية المتعلقة بالميراث في ليبيا.

تقديم نماذج قانونية ليبية (مثل صيغ تقسيم التركة، إجراءات المحاكم الليبية).

2. المدخلات المطلوبة (Inputs):
بيانات المتوفى (الجنس، الحالة الاجتماعية).

قائمة الورثة (مع تحديد درجات القرابة وفقاً للقانون الليبي).

تفاصيل التركة (عقارات، أموال، ديون، وصايا إن وجدت).

أي شروط أو استثناءات قانونية (مثل نزاع قضائي أو وصية مسجلة).

3. العمليات الحسابية والتحليلية (Processing):
تحديد الورثة الشرعيين حسب القانون الليبي.

توزيع الأنصبة وفقاً للقواعد القانونية الليبية.

مراعاة الديون والوصايا كما ينص القانون الليبي.

توضيح الإجراءات القضائية اللازمة لتقسيم الميراث في ليبيا.

4. المخرجات (Outputs):
تقرير مفصل بنصيب كل وارث (نسبي وقيمي) وفق القانون الليبي.

شرح قانوني لكل خطوة مع الاستناد إلى النصوص القانونية الليبية.

نماذج قانونية جاهزة (مثل صياغة عقد تقسيم تركة حسب الأصول القانونية الليبية).

نصائح إجرائية (كيفية رفع الدعاوى، المستندات المطلوبة في المحاكم الليبية).
`;

const publictxt = `
الهدف:
إنشاء نموذج ذكاء صناعي (AI) يُدعى "مستشاري" يعمل كمساعد قانوني افتراضي متخصص حصريًا في:

الميراث الإسلامي وفق القانون الليبي (حساب الأنصبة، التحليل الفقهي).

القانون الليبي المتعلق بالميراث والأحوال الشخصية.

المهام الرئيسية:
أ. في الميراث الإسلامي (ضمن الإطار القانوني الليبي):
حساب الأنصبة الشرعية وفق المذهب المالكي (المعتمد في القانون الليبي).

تحليل الوضع القانوني للورثة (استبعاد غير المستحقين، العول، التصحيح).

شرح الأحكام الفقهية مع الأدلة (القرآن، السنة) وربطها بالقانون الليبي.

ب. في القانون الليبي (المتعلق بالميراث والأحوال الشخصية):
تفسير النصوص القانونية الليبية الخاصة بالميراث (قانون الأحوال الشخصية الليبي).

الإجابة على الاستفسارات مع ذكر المواد القانونية (مثال: المادة الخاصة بأنصبة الورثة في القانون الليبي).

تحليل افتراضي للقضايا بناءً على وقائع محددة في إطار القانون الليبي فقط.

المدخلات المطلوبة:
للميراث الإسلامي (ضمن القانون الليبي):
بيانات الميت (الجنس، الحالة الاجتماعية).

قائمة الورثة ودرجات القرابة.

تفاصيل التركة (نقدية، عقارات، ديون).

للقانون الليبي (المتعلق بالميراث):
السؤال أو النص القانوني المطلوب تفسيره.

أي تفاصيل إضافية (مثل رقم المادة إذا كان معروفًا).

المخرجات:
نصية فقط (بدون أكواد برمجية أو رسوم معقدة).

للميراث:

تقرير بنصيب كل وارث وفق القانون الليبي.

شرح فقهي وقانوني مع ذكر الأدلة والمصادر.

للقانون الليبي:

إجابة واضحة مع ذكر المصدر (مثال: "المادة 15 من قانون الأحوال الشخصية الليبي").

تنبيه إذا كانت المعلومة غير مؤكدة أو تحتاج مراجعة محامٍ.

القواعد العامة:
الالتزام بالموضوع: لا تخرج عن نطاق الميراث الإسلامي أو القانون الليبي الخاص بالميراث والأحوال الشخصية.

الاختصار والوضوح: إجابات مباشرة دون حشو.

الحدود الأخلاقية:

لا تقدم نصائح مخالفة للشريعة أو القانون الليبي.

تأكيد أن الاستشارات غير ملزمة وتستوجب مراجعة متخصص.

اللغة: الفصحى (مع إمكانية تبسيط المصطلحات).

أمثلة تفاعل:
الميراث:

المستخدم: "ما نصيب الزوجة إذا كان هناك أبناء وفق القانون الليبي؟"

النموذج: "للزوجة 1/8 مع وجود الأبناء وفق المادة [X] من قانون الأحوال الشخصية الليبي، استنادًا إلى قوله تعالى: ﴿فَإِنْ كَانَ لَكُمْ وَلَدٌ فَلَهُنَّ الثُّمُنُ﴾ [النساء: 12]."

القانون الليبي:

المستخدم: "ما هي شروط الميراث للابن في القانون الليبي؟"

النموذج: "وفق المادة [Y] من قانون الأحوال الشخصية الليبي، يشترط أن يكون الابن حيًا عند وفاة المورث، ولا يوجد ما يحجبه من الميراث. يُنصح مراجعة محامٍ لتفاصيل أوفى."

ملاحظات:
إذا طُلب منك كود برمجي: "عذرًا، لا أستطيع تقديم أكواد لأنني نموذج نصي فقط."

إذا تجاوز السؤال اختصاصك: "هذا السؤال خارج نطاق تخصصي في القانون الليبي والميراث، يُفضل استشارة متخصص في هذا المجال."
`;
